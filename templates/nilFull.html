<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>NIL Rating Project: MILANO</title>
    <link rel="stylesheet" href="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v5.3.0/css/ol.css" type="text/css">
    <style>
      body {
        /* Permalink - use to edit and share this gradient: https://colorzilla.com/gradient-editor/#ffffff+0,f6f6f6+47,ededed+100;White+3D+%231 */
        background: rgb(255,255,255); /* Old browsers */
        background: -moz-radial-gradient(center, ellipse cover,  rgba(255,255,255,1) 0%, rgba(246,246,246,1) 47%, rgba(237,237,237,1) 100%); /* FF3.6-15 */
        background: -webkit-radial-gradient(center, ellipse cover,  rgba(255,255,255,1) 0%,rgba(246,246,246,1) 47%,rgba(237,237,237,1) 100%); /* Chrome10-25,Safari5.1-6 */
        background: radial-gradient(ellipse at center,  rgba(255,255,255,1) 0%,rgba(246,246,246,1) 47%,rgba(237,237,237,1) 100%); /* W3C, IE10+, FF16+, Chrome26+, Opera12+, Safari7+ */
        filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#ffffff', endColorstr='#ededed',GradientType=1 ); /* IE6-9 fallback on horizontal gradient */

      }
      #map {
        height: 600px;
        width: 80%;
        position: relative;
        margin: auto auto 0% 10%;
        border: 2px solid black;
      }
      h2{  
       font-size: 50px;
       font-weight: normal;
       line-height: 1;
       text-align: center;
       margin: 0px 50px 0 50px;
       padding-top: 0px; 
      }
      h3{  
       font-size: 50px;
       font-weight: normal;
       line-height: 1;
       text-align: center;
       margin: 0px 0 0;
       padding-top: 0px; 
       padding-bottom: 0px;
      }
      .tooltip.in {
        opacity: 1;
      }
      .tooltip.top .tooltip-arrow {
        border-top-color: white;
      }
      .tooltip-inner {
        border: 2px solid white;
      }
      #info {
        position: absolute;
        height: 1px;
        width: 1px;
        z-index: -1;
      }
      #info2{
        text-align: center;
      }
      #container1
      {
        width:96%; 
        display: inline;
        text-align: center;
      }
      #send
      {
        text-align: center;
        margin-left: 2%;
      }
      #tot
      {
        text-align: right;
        margin-left: 83%;
      }
      ol{ 
        display:table; 
        text-align: left;
        margin:0 auto;
      }
    </style>
  </head>
  <body>
    <h2>Valuta le zone di MILANO!</h2>
    <div class="row">
      <div class="col-sm-11">
        <span id="tot">Totale partecipanti:</span>
      </div>
    </div>
    <div id="map" class="map">
      <div id="info">&nbsp;</div>
    </div>
    <br>
    <div id="container1" style="display:none;">
      <div class="col-sm-4"></div>
      <div class="col-sm-4">
        <div class="panel panel-primary bg-light">
          <div id="info2" class="panel-success bg-primary border border-primary">&nbsp;</div>
          <div id="nvotes" class="panel-text bg-primary border border-primary">&nbsp;</div>
        </div>
      </div>
      <div class="col-sm-4"></div>
    </div>
    <div class="row"></div>
    <div class="box" id="box2" align="center">
     <h3 class="text-center">Valuta i Nuclei di Identità Locale (NIL) che compongono Milano!</h3>
     <p class="panel-text">Fai click su uno dei NIL della mappa e valuta la zona selezionata su 4 categorie:</p>
       <ol>
         <li>Rapporto qualità zona / prezzo immobili</li>
         <li>Servizi disponibili, clima e ambiente</li>
         <li>Cultura e tempo libero</li>
         <li>Sicurezza e vivibilità della zona</li>
       </ol>
      <p class="panel-text">La media voti delle categorie contribuirà a stabilire il rate medio (Avg. Rate) che sarà assegnato alla zona.</p>
      <br>
      <br>
    </div>
    <div class="box" id="box1" style="display:none;" >
      <h3 class="text-center" id="t1"><a href="#p1">1 - Rapporto qualità della zona / prezzo degli immobili</a></h3>
      <div class="container">
        <div class="col-sm">
          <div class="panel panel-default">
            <div class="panel-body text-center">
              <div class="panel-text" id="p1" style="display:none;">
                <font size="2">
                  <p class="panel-text">Indica il rapporto tra la qualità della vita offerta dalla zona e il costo necessario a viverci.<br>
                  In questo parametro è da considerare il costo relativo sia ad appartamenti in affitto che a locazioni in vendita sulla base del prezzo del mattone.<br>
                  Voti bassi indicano prezzi degli immobili troppo elevati rispetto alla zona. Al contrario, voti alti implicano prezzi convenienti in zona. </p>
                </font>
              </div>
              <div class="row justify-content-md-center">
                <div class="col-sm-4"></div>
                <div class="col-sm-4">
                  <div class="rateit" id="rateit1"  data-rateit-mode="font"  style="font-size:50px" ></div>
                </div>
                <div class="col-sm-4"></div>
              </div>
              <div class="row justify-content-md-center">
                <div class="col-sm-4">
                </div>
                <div class="col-sm-4">
                  <div id="preset1" style="font-size:14px"></div>
                  <div id="value1" style="font-size:14px"></div>
                </div>
                <div class="col-sm-4">
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <br/>
      <h3 class="text-center" id="t2"><a href="#p2">2 - Servizi disponibili, clima e ambiente</a></h3>
      <div class="container" >
        <div class="col-sm">
          <div class="panel panel-default">
            <div class="panel-body text-center">
              <div class="panel-text" id="p2" style="display:none;">
                <font size="2">
                  <p class="panel-text">Per servizi si intende: presenza in zona di stazioni metropolitane, capillarità dei mezzi pubblici, disponibilità dei servizi di sharing come bici, moto e auto ma anche la presenza di attività commerciali come bar, supermercati e negozi.<br>
                  Per clima e ambiente si intende invece la presenza di parchi pubblici, giardini e verde in generale. Di conseguenza la qualità dell'aria respirata.</p>
                </font>
              </div>
              <div class="row justify-content-md-center">
                <div class="col-sm-4"></div>
                <div class="col-sm-4">
                  <div class="rateit" id="rateit2"  data-rateit-mode="font"  style="font-size:50px" ></div>
                </div>
                <div class="col-sm-4"></div>
              </div>
              <div class="row justify-content-md-center">
                <div class="col-sm-4"></div>
                <div class="col-sm-4">
                  <div id="preset2" style="font-size:14px"></div>
                  <div id="value2" style="font-size:14px"></div>
                </div>
                <div class="col-sm-4"></div>
              </div>
            </div>  
          </div>
        </div>
      </div>
      <br/>
      <h3 class="text-center" id="t3"><a href="#p3">3 - Cultura e tempo libero</a></h3>
      <div class="container" >
        <div class="col-sm">
          <div class="panel panel-default">
            <div class="panel-body text-center">
              <div class="panel-text"  id="p3" style="display:none;">
                <font size="2">
                  <p class="panel-text">Presenza di scuole, librerie, palestre, sale cinematografiche, spettacoli teatrali, concerti e altri eventi sociali cui partecipare, ma anche pub, locali, ristoranti e altri luoghi di ritrovo.</p>
                <font size="2">
              </div>
              <div class="row justify-content-md-center">
                <div class="col-sm-4"></div>
                <div class="col-sm-4">
                  <div class="rateit" id="rateit3"  data-rateit-mode="font"  style="font-size:50px" ></div>
                </div>
                <div class="col-sm-4"></div>
              </div>
              <div class="row justify-content-md-center">
                <div class="col-sm-4"></div>
                <div class="col-sm-4">
                  <div id="preset3" style="font-size:14px"></div>
                  <div id="value3" style="font-size:14px"></div>
                </div>
                <div class="col-sm-4"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <h3 class="text-center" id="t4"><a href="#p4">4 - Sicurezza e vivibilità della zona</a></h3>
      <div class="container" >
        <div class="col-sm">
          <div class="panel panel-default">
            <div class="panel-body text-center">
              <div class="panel-text"  id="p4" style="display:none;">
                <font size="2">
                  <p class="panel-text">Indice sulla vivibilità della zona. Sicurezza percepita sia nei complessi residenziali quanto nei luoghi comuni (piazze, parchi, punti di ritrovo)</p>
                </font>
              </div>
              <div class="row justify-content-md-center">
                <div class="col-sm-4"></div>
                <div class="col-sm-4">
                  <div class="rateit" id="rateit4"  data-rateit-mode="font"  style="font-size:50px" ></div>
                </div>
                <div class="col-sm-4"></div>
              </div>
              <div class="row justify-content-md-center">
                <div class="col-sm-4"></div>
                <div class="col-sm-4">
                  <div id="preset4" style="font-size:14px"></div>
                  <div id="value4" style="font-size:14px"></div>
                </div>
                <div class="col-sm-4"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <br/>
      <div class="container">
        <div class="row">
          <div class="col text-center">
            <button id="send" class="btn btn-success btn-lg">INVIA VOTI</button><span id="checkOK"></span>
          </div>
          <div class="col text-center">
            <div id="okmsg"></div>
          </div>
        </div>
      </div>
    </div>  
    <br/>
    <br/>
    <script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList,URL"></script>
    <script src="https://code.jquery.com/jquery-2.2.3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <script src="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v5.3.0/build/ol.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.rateit/1.1.2/jquery.rateit.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery.rateit/1.1.2/rateit.css">
	  <!-- <link href="{{ url_for('static', filename='css/rateit.css') }}" rel="stylesheet" type="text/css"> -->
    <!-- <link href="{{ url_for('static', filename='css/nil3.css') }}" rel="stylesheet" type="text/css"> -->
    <script type="module">

      // CONVERT imports to var
     var Map                 = ol.Map;        //~ import Map from 'ol/Map.js';
     var View                = ol.View;       //~ import View from 'ol/View.js';
     var TileLayer           = ol.layer.Tile; //~ import TileLayer from 'ol/layer/Tile.js';
     var VectorLayer         = ol.layer.Vector; //~ import TileLayer from 'ol/layer/Tile.js';
     var VectorSource        = ol.source.Vector;
     var Stamen              = ol.source.Stamen;
     var GeoJSON             = ol.format.GeoJSON;
     var CircleStyle         = ol.style.Cyrcle;
     var Fill                = ol.style.Fill;
     var Stroke              = ol.style.Stroke;
     var Style               = ol.style.Style;
     var Text                = ol.style.Text;
     var {fromLonLat}        = ol.proj;       //~ import {fromLonLat} from 'ol/proj.js';
     var OSM                 = ol.source.OSM; //~ import OSM from 'ol/source/OSM.js'; 
     
     var nil = '';
     var id_nil = -1;
     var set1 = false;
     var set2 = false;
     var set3 = false;
     var set4 = false;

    /*** BACKGROUND SHADES **/
     const colors = ['FF0000','FF3300','FF6600','FF9900','FFCC00','FFFF00','AAFF00','99FF00','66FF00','33FF00','00FF00'];
     var conv = function hexToRGB(hex, alpha) {
          var r = parseInt(hex.slice(1, 3), 16);
          var g = parseInt(hex.slice(3, 5), 16);
          var b = parseInt(hex.slice(5, 7), 16);

          if (alpha) {
              return "rgba(" + r + ", " + g + ", " + b + ", " + alpha + ")";
          } else {
              return "rgb(" + r + ", " + g + ", " + b + ")";
          }
      }

      function getColor(id) {
        id = id*2;
        const index = (Math.round(id * 2) / 2).toFixed(0);
        return conv(colors[index], 0.8);
      }

      var bg = function dynamicBackground(val, nil){
        var depth = val ;
        //console.log(depth, nil);
        if (val == null){
          return new Style({stroke: new Stroke({
            color: '#f00',
            width: 1
          }),
          fill: new Fill({
            color : "rgba(0,0,0,0)"
          })
        });
        }
        var style = new Style({
          stroke: new Stroke({
            color: '#f00',
            width: 1
          }),
          fill: new Fill({
            color : getColor(depth)
          })
        });
        return style;
      }


      /*** LAYERS **/

      const base = new TileLayer({
        source: new OSM()
      })


      
      //SYNC
      var rate = (function setRate() {
        var data;
        $.ajax({
          url: "http://localhost:8080/getrating",
          async: false, 
          dataType: 'json',
          success: function (json) {
            //console.log(json);
            data = json;
          }
        });
        return data;
      })();

      //ASYNC
      var tot;
      function callback(response) {
        tot = response;
        $('#tot').append('    ' + tot);
      }
      $.getJSON("http://localhost:8080/totalvotes").success(function(data) {
          console.log("data: " + JSON.stringify(data));
          callback(data);
      });

      var vectorLayer = new VectorLayer({
        source: new VectorSource({
          url: './nilzone2.geojson',
          format: new GeoJSON(),
          projection : 'EPSG:3857'
        }),
        style: function(feature) {
            const idNil = feature.get('ID_NIL');
            const nil = feature.get('NIL');
            //const r = feature.get('rating');
            var r = 0
            for(var i=0; i<rate.length; i++){
              if(feature.get('ID_NIL') == rate[i].id_nil){
                r = rate[i].avg_rate;
                break;
              }
            }
            return bg(r, nil);
          }
      });

      const raster = new TileLayer({
        source: new Stamen({
          layer: 'toner'
        })
      });

      const map = new Map({
        controls: [new ol.control.Zoom(), new ol.control.ScaleLine()],
        layers: [raster,vectorLayer],
        target: 'map',
        view: new View({
          projection: 'EPSG:3857',
          center: fromLonLat([9.18, 45.46]),
          zoom: 12
        })
      });

      var highlightStyle = new Style({
        stroke: new Stroke({
          color: '#f00',
          width: 1
        }),
        fill: new Fill({
          color: 'rgba(255,100,0,0.3)'
        }),
        text: new Text({
          font: '12px Calibri,sans-serif',
          fill: new Fill({
            color: '#000'
          }),
          stroke: new Stroke({
            color: '#f00',
            width: 3
          })
        })
      });

      var featureOverlay = new VectorLayer({
        source: new VectorSource(),
        map: map,
        style: function(feature) {
          highlightStyle.getText().setText(feature.get('NIL'));
          return highlightStyle;
        }
      });


      const info = $('#info');
      info.tooltip({
        animation: false,
        trigger: 'manual'
      });

      var highlight;
      const displayFeatureInfo = function(pixel) {
        info.css({
          left: pixel[0] + 'px',
          top: (pixel[1] - 10) + 'px'
        });
        const feature = map.forEachFeatureAtPixel(pixel, function(feature) {
          return feature;
        });

        if (feature) {
          var avgRate = null;
          for(var i=0; i<rate.length; i++){
            if(feature.get('ID_NIL') == rate[i].id_nil){
              avgRate = rate[i].avg_rate;
              break;
            }
          }
          var txt = ''
          if(avgRate==null) 
            txt = feature.get('NIL');
          else
            txt = feature.get('NIL') +  " (avg. rate: " + avgRate + ")";

          info.tooltip('hide')
            .attr('data-original-title', txt)
            .tooltip('fixTitle')
            .tooltip('show');
        } else {
          info.tooltip('hide');
        }

        if (feature !== highlight) {
          if (highlight) {
            featureOverlay.getSource().removeFeature(highlight);
          }
          if (feature) {
            featureOverlay.getSource().addFeature(feature);
          }
          highlight = feature;
        }
      };

      map.on('pointermove', function(evt) {
        if (evt.dragging) {
          info.tooltip('hide');
          return;
        }
        displayFeatureInfo(map.getEventPixel(evt.originalEvent));
      });

      $('#t1').on('click', function(evt) {
        evt.preventDefault();
        $('#p1').toggle();
        return false;
      });
      $('#t2').on('click', function(evt) {
        evt.preventDefault();
        $('#p2').toggle();
        return false;
      });
      $('#t3').on('click', function(evt) {
        evt.preventDefault();
        $('#p3').toggle();
        return false;
      });
      $('#t4').on('click', function(evt) {
        evt.preventDefault();
        $('#p4').toggle();
        return false;
      });

      map.on('click', function(evt) {
        const feature = map.forEachFeatureAtPixel(map.getEventPixel(evt.originalEvent), function(feature) {
          return feature;
        });
        displayFeatureInfo(evt.pixel);

        id_nil =  feature.get('ID_NIL');
        nil = feature.get('NIL');

        $('#box2').hide();
        $('#box1').show();
        $('#container1').show();
        $('#send').attr("disabled", false);
        $('#checkOK').text('');
	$('#okmsg').text('');
        $('#p1').hide();
        $('#p2').hide();
        $('#p3').hide();
        $('#p4').hide();

	      
	if($('#send').hasClass("btn-danger"))
          $('#send').removeClass("btn-danger").addClass("btn-success").text("INVIA VOTI");
        else
          $('#send').addClass("btn-success").text("INVIA VOTI");
        
	
        $('html, body').animate({
            scrollTop: $("#container1").offset().top
        }, 1000);

        if (feature) {
          $("#info2").css('fontSize', 20).addClass('text-info').text(feature.get('ID_NIL') + ': ' + feature.get('NIL'));
          //info2.innerHTML = feature.get('ID_NIL') + ': ' + feature.get('NIL');
        } else {
          //info2.innerHTML = '&nbsp;';
          $("#info2").text('');
        }

         //MAKE CALL
        $.getJSON("http://localhost:8080/getvotes").success(function(data) {
           //console.log(data);
           //console.log("LOG: " + JSON.stringify(JSON.parse(readVotes.responseText)[feature.get('NIL')]));
           var readVotes = JSON.parse(JSON.stringify(data, null, 2));;
           //console.log(readVotes[0].id_nil);


           //READ AVG VOTES
           for(var i=0; i<readVotes.length; i++){
            if(readVotes[i].id_nil == feature.get('ID_NIL')){
              console.log("MATCH: " + readVotes[i].id_nil);
              if(readVotes[i].nvotes == null)
                $('#nvotes').addClass('text-info').text('Num. voti: 0');
              else
                $('#nvotes').addClass('text-info').text('Num. voti: ' + readVotes[i].nvotes);
              $("#rateit1").rateit('value', Number(readVotes[i].avg_vote1).toFixed(2));
              $("#rateit2").rateit('value', Number(readVotes[i].avg_vote2).toFixed(2));
              $("#rateit3").rateit('value', Number(readVotes[i].avg_vote3).toFixed(2));
              $("#rateit4").rateit('value', Number(readVotes[i].avg_vote4).toFixed(2));
              break;
            }
           }

           //NO USER CHOICE
           $('#value1').text('');
           $('#value2').text('');
           $('#value3').text('');
           $('#value4').text('');


           //PRESET
           $('#preset1').text('[Media voti: ' +  $("#rateit1").rateit('value') + ']');
           $('#preset2').text('[Media voti: ' +  $("#rateit2").rateit('value') + ']');
           $('#preset3').text('[Media voti: ' +  $("#rateit3").rateit('value') + ']');
           $('#preset4').text('[Media voti: ' +  $("#rateit4").rateit('value') + ']');

           //HOVER
           $("#rateit1").on('over', function (event,value) { $(this).attr('title', value); });
           $("#rateit2").on('over', function (event,value) { $(this).attr('title', value); });
           $("#rateit3").on('over', function (event,value) { $(this).attr('title', value); });
           $("#rateit4").on('over', function (event,value) { $(this).attr('title', value); });

           //CLICK
           $("#rateit1").on('click', function () { set1 = true; });
           $("#rateit2").on('click', function () { set2 = true; });
           $("#rateit3").on('click', function () { set3 = true; });
           $("#rateit4").on('click', function () { set4 = true; });

           //VOTE
           $("#rateit1").on('rated', function (event, value) { $('#value1').css('color', 'red').text('Tuo voto: ' +  $("#rateit1").rateit('value') + ''); });
           $("#rateit2").on('rated', function (event, value) { $('#value2').css('color', 'red').text('Tuo voto: ' +  $("#rateit2").rateit('value') + ''); });
           $("#rateit3").on('rated', function (event, value) { $('#value3').css('color', 'red').text('Tuo voto: ' +  $("#rateit3").rateit('value') + ''); });
           $("#rateit4").on('rated', function (event, value) { $('#value4').css('color', 'red').text('Tuo voto: ' +  $("#rateit4").rateit('value') + ''); });

           //RESET
           $("#rateit1").on('reset', function (event, value) { $('#value1').css('color', 'red').text('Tuo voto: ' +  $("#rateit1").rateit('value') + ''); });
           $("#rateit2").on('reset', function (event, value) { $('#value2').css('color', 'red').text('Tuo voto: ' +  $("#rateit2").rateit('value') + ''); });
           $("#rateit3").on('reset', function (event, value) { $('#value3').css('color', 'red').text('Tuo voto: ' +  $("#rateit3").rateit('value') + ''); });
           $("#rateit4").on('reset', function (event, value) { $('#value4').css('color', 'red').text('Tuo voto: ' +  $("#rateit4").rateit('value') + ''); });

        });
	set1 = false;
        set2 = false;
        set3 = false;
        set4 = false;
      });


       $(function() {
           $('#send').on('click', function() {
           console.log("R1: " + $("#rateit1").rateit('value'));
           console.log("R2: " + $("#rateit2").rateit('value'));
           console.log("R3: " + $("#rateit3").rateit('value'));
           console.log("R4: " + $("#rateit4").rateit('value'));

	   if(!(set1 && set2 && set3 && set4)){
           	alert("Dai un voto a tutte e 4 le categorie!");
           }
           else{
		   $.getJSON('https://api.ipify.org?format=jsonp&callback=?').success(function(data) {
			 var o = JSON.parse(JSON.stringify(data, null, 2));
			 console.log(o.ip);
			 console.log(id_nil, nil);
			 $.ajax({
			   url : "http://localhost:8080/vote",
			   data: { 'v1' :  $("#rateit1").rateit('value'),
				   'v2' :  $("#rateit2").rateit('value'),
				   'v3' :  $("#rateit3").rateit('value'),
				   'v4' :  $("#rateit4").rateit('value'),
				   'nil' :  nil,
				   'id_nil' : id_nil,
				   'ip' : o.ip
			   },
			   type: 'POST',
			   success : function (resp,state) {
			      console.log(resp);
			      $('#checkOK').html('&#9989;').text();
			      $('#okmsg').text("Il tuo contributo verrà aggiunto sulla mappa entro 5 minuti!");
			   },
			   error : function (req,state,error) {
			      console.log(state)
           	              console.log(error)
           	              if(error == 'FORBIDDEN'){
           	                alert("Hai già votato questa zona!");
                                $('#okmsg').text("Hai già votato questa zona!");
                              }
           	              else{
           	                alert("E' avvenuto un errore. Lo stato della chiamata è: "+state);
                              }
                              $('#checkOK').html('&#9888;').text();
                              $('#send').removeClass("btn-success").addClass("btn-danger").text("Errore");
			  }
		      });
		   })
		   .error(function() {
		     $('#checkOK').html('&#9888;').text();
		     $('#send').removeClass("btn-success").addClass("btn-danger").text("Errore");
		     alert("ATTENZIONE: Disattiva AdBlock o UBlock dal tuo browser per votare!");
		     $('#okmsg').text("ATTENZIONE: Disattiva AdBlock o UBlock dal tuo browser per votare!");
		   });
		 $('#send').attr("disabled", true);
		 $('#send').text("Grazie per aver votato!");
	   }
         });
      });
       

      console.log('FINE Rendering');

      /***********************************************************************************************************************/
     
      
     
    </script>

  </body>
</html>
